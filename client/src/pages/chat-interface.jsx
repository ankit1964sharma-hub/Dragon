import { useState, useRef, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";
import { Separator } from "@/components/ui/separator";
import { Hash, Settings, Mic, Headphones, Plus, Gift, Sticker, Smile } from "lucide-react";
import { cn } from "@/lib/utils";
// @ts-ignore
import botAvatar from "@assets/generated_images/cyberpunk_discord_bot_avatar.png"; const ADMIN_ID = "763625050213187614";
const CHANNELS = [ { id: "general", name: "general", type: "text" }, { id: "catching", name: "catching", type: "text" }, { id: "proofs", name: "proofs", type: "text" }, { id: "spam", name: "spam", type: "text" },
]; type Message = { id; content; authorId; timestamp; isBot; channelId;
}; type User = { id; username; discriminator; messages; catches; pokecoins; shinyCatches?; rareShinyCatches?;
}; type BotSettings = { id; eventActive; pokecoinRate; countingChannels[]; proofsChannelId | null; adminUserId;
}; export default function ChatInterface() { const [activeChannel, setActiveChannel] = useState("general"); const [inputValue, setInputValue] = useState(""); const [localMessages, setLocalMessages] = useState<Message[]>([]); const scrollRef = useRef(null); const queryClient = useQueryClient(); const currentUser = { id, username: "AdminUser", discriminator: "0001", }; // Fetch users const { data: users = [] } = useQuery<User[]>({ queryKey: ["/api/users"], }); // Fetch settings const { data: settings } = useQuery({ queryKey: ["/api/settings"], }); // Send message mutation const sendMessageMutation = useMutation({ mutationFn: async (data: { userId; username; discriminator; channelId; content }) => { const response = await fetch("/api/messages", { method: "POST", headers: { "Content-Type": "application/json" }, body.stringify(data), }); if (!response.ok) throw new Error("Failed to send message"); return response.json(); }, onSuccess: () => { queryClient.invalidateQueries({ queryKey: ["/api/users"] }); }, }); // Catch mutation const catchMutation = useMutation({ mutationFn: async (data: { userId; username; discriminator }) => { const response = await fetch("/api/catches", { method: "POST", headers: { "Content-Type": "application/json" }, body.stringify(data), }); if (!response.ok) throw new Error("Failed to catch"); return response.json(); }, onSuccess: () => { queryClient.invalidateQueries({ queryKey: ["/api/users"] }); }, }); // Event toggle mutation const toggleEventMutation = useMutation({ mutationFn: async (active) => { const response = await fetch("/api/settings/event", { method: "PATCH", headers: { "Content-Type": "application/json" }, body.stringify({ active, adminUserId: currentUser.id }), }); if (!response.ok) throw new Error("Failed to toggle event"); return response.json(); }, onSuccess: () => { queryClient.invalidateQueries({ queryKey: ["/api/settings"] }); }, }); // Rate update mutation const updateRateMutation = useMutation({ mutationFn: async (rate) => { const response = await fetch("/api/settings/pokecoin-rate", { method: "PATCH", headers: { "Content-Type": "application/json" }, body.stringify({ rate, adminUserId: currentUser.id }), }); if (!response.ok) throw new Error("Failed to update rate"); return response.json(); }, onSuccess: () => { queryClient.invalidateQueries({ queryKey: ["/api/settings"] }); }, }); // Reset user mutation const resetUserMutation = useMutation({ mutationFn: async ({ userId, type }: { userId; type: "messages" | "catches" | "all" }) => { const response = await fetch(`/api/users/${userId}/reset`, { method: "POST", headers: { "Content-Type": "application/json" }, body.stringify({ type, adminUserId: currentUser.id }), }); if (!response.ok) throw new Error("Failed to reset user"); return response.json(); }, onSuccess: () => { queryClient.invalidateQueries({ queryKey: ["/api/users"] }); }, }); // Reset all mutation const resetAllMutation = useMutation({ mutationFn: async (type: "messages" | "catches" | "all") => { const response = await fetch("/api/users/reset-all", { method: "POST", headers: { "Content-Type": "application/json" }, body.stringify({ type, adminUserId: currentUser.id }), }); if (!response.ok) throw new Error("Failed to reset all"); return response.json(); }, onSuccess: () => { queryClient.invalidateQueries({ queryKey: ["/api/users"] }); }, }); const createBotMessage = (content) => ({ id.random().toString(36).substr(2, 9), content, authorId: "bot", timestamp: new Date(), isBot: true, channelId: activeChannel, }); const processCommand = async (content, authorId, channelId) => { const args = content.trim().split(" "); const command = args[0].toLowerCase(); if (!command.startsWith(".") && !command.startsWith("-")) return null; const cmd = command.startsWith(".") ? command.slice(1) : command.slice(1); // .help if (cmd === "help") { return createBotMessage(`**ðŸ¤– Bot Commands** **ðŸ“Š Statistics**
\`.catches\` - View your catch stats
\`.leaderboard messages\` or \`.lb messages\` - Message leaderboard
\`.leaderboard catches\` or \`.lb catches\` - Catch leaderboard
\`.profile\` - Check your stats **ðŸŽ® Actions**
\`.withdraw [market_id]\` - Withdraw coins **âš™ï¸ Admin Only**
\`.event [on/off]\` - Toggle event
\`.reset [messages/catches/all] [user_id/all]\` - Reset stats
\`.rate [amount]\` - Set Pokecoin rate`); } // .catches if (cmd === "catches") { const user = users.find(u => u.id === authorId); if (!user) return createBotMessage("You don't have any catches yet!"); const catchRank = [...users].sort((a, b) => b.catches - a.catches).findIndex(u => u.id === authorId) + 1; const totalCatches = users.reduce((sum, u) => sum + u.catches, 0); return createBotMessage(`**ðŸ•¸ï¸ ${user.username}'s Catches** ðŸ•¸ï¸ Total Catches: **${user.catches}**
âœ¨ Shiny Catches: **${user.shinyCatches || 0}**
ðŸ’Ž Rare Shiny: **${user.rareShinyCatches || 0}**
ðŸ“Š Rank: #${catchRank} of ${users.length}
ðŸª™ Pokecoins: ${user.pokecoins} ðŸ“ˆ Server Total: ${totalCatches} catches`); } // .leaderboard if (cmd === "leaderboard" || cmd === "lb") { const lbType = args[1]?.toLowerCase(); if (lbType === "catches") { const sortedUsers = [...users].sort((a, b) => b.catches - a.catches).slice(0, 10); const totalCatches = users.reduce((sum, u) => sum + u.catches, 0); const lbString = sortedUsers.map((u, i) => { const medal = i === 0 ? "ðŸ¥‡" : i === 1 ? "ðŸ¥ˆ" : i === 2 ? "ðŸ¥‰" : `#${i + 1}`; return `${medal} **${u.username}**\nðŸ•¸ï¸ **${u.catches}** catches | ðŸª™ ${u.pokecoins} coins`; }).join("\n\n"); return createBotMessage(`**ðŸ•¸ï¸ Catches Leaderboard**\n\n${lbString || "No catches yet!"}\n\nðŸ“ˆ Total Catches: ${totalCatches} | ðŸ‘¥ Active Users: ${users.length}`); } else if (lbType === "messages") { const sortedUsers = [...users].sort((a, b) => b.messages - a.messages).slice(0, 10); const totalMessages = users.reduce((sum, u) => sum + u.messages, 0); const lbString = sortedUsers.map((u, i) => { const medal = i === 0 ? "ðŸ¥‡" : i === 1 ? "ðŸ¥ˆ" : i === 2 ? "ðŸ¥‰" : `#${i + 1}`; return `${medal} **${u.username}**\nðŸ’¬ **${u.messages}** messages | ðŸª™ ${u.pokecoins} coins`; }).join("\n\n"); return createBotMessage(`**ðŸ’¬ Messages Leaderboard**\n\n${lbString || "No messages yet!"}\n\nðŸ“ˆ Total Messages: ${totalMessages} | ðŸ‘¥ Active Users: ${users.length}`); } else { return createBotMessage("Please specify leaderboard type: `.lb messages` or `.lb catches`"); } } // .profile if (cmd === "profile") { const user = users.find(u => u.id === authorId); if (!user) return createBotMessage("You don't have any stats yet!"); const messageRank = [...users].sort((a, b) => b.messages - a.messages).findIndex(u => u.id === authorId) + 1; const catchRank = [...users].sort((a, b) => b.catches - a.catches).findIndex(u => u.id === authorId) + 1; return createBotMessage(`**ðŸ“Š ${user.username}'s Profile**\n\nðŸ’¬ Messages: **${user.messages}** (Rank: #${messageRank})\nðŸ•¸ï¸ Catches: **${user.catches}** (Rank: #${catchRank})\nðŸª™ Pokecoins: ${user.pokecoins}`); } // .event [on/off] if (cmd === "event") { if (authorId !== ADMIN_ID) return createBotMessage("âŒ You do not have permission."); const state = args[1]?.toLowerCase(); if (state === "on") { toggleEventMutation.mutate(true); return createBotMessage("âœ… Event has been turned **ON**."); } else if (state === "off") { toggleEventMutation.mutate(false); return createBotMessage("ðŸ›‘ Event has been turned **OFF**."); } return createBotMessage("Usage: `.event on` or `.event off`"); } // .reset if (cmd === "reset") { if (authorId !== ADMIN_ID) return createBotMessage("âŒ You do not have permission."); const targetType = args[1]?.toLowerCase(); const targetUser = args[2]; if (!["messages", "catches", "all"].includes(targetType)) { return createBotMessage("Usage: `.reset [messages/catches/all] [user_id/all]`"); } if (targetUser === "all") { resetAllMutation.mutate(targetType as any); return createBotMessage(`âœ… Reset **${targetType}** for **all users**.`); } else if (targetUser) { resetUserMutation.mutate({ userId: targetUser, type: targetType as any }); return createBotMessage(`âœ… Reset **${targetType}** for user **${targetUser}**.`); } return createBotMessage("Please specify a user ID or 'all'"); } // .rate if (cmd === "rate") { if (authorId !== ADMIN_ID) return createBotMessage("âŒ You do not have permission."); const amount = parseInt(args[1]); if (isNaN(amount)) return createBotMessage("Usage: `.rate [number]`"); updateRateMutation.mutate(amount); return createBotMessage(`âœ… Pokecoin rate set to **${amount}** coins per milestone.`); } // .withdraw if (cmd === "withdraw") { const marketId = args[1]; if (!marketId) return createBotMessage("Usage: `.withdraw [market_id]`"); return createBotMessage(`Processing withdrawal for Market ID: ${marketId}...\nPlease pay the bot, then type \`-payed 1\` in the #proofs channel.`); } // -payed if (command.startsWith("-payed")) { if (channelId !== "proofs") return createBotMessage("âŒ Please use this command in the #proofs channel."); return createBotMessage("âœ… Payment verified! Request submitted."); } return null; }; const handleSend = async () => { if (!inputValue.trim()) return; const messageContent = inputValue; setInputValue(""); try { const result = await sendMessageMutation.mutateAsync({ content: messageContent, userId: currentUser.id, username: currentUser.username, discriminator: currentUser.discriminator, channelId: activeChannel, }); // Add the saved message to local state setLocalMessages((prev) => [...prev, result.message]); // Show spam warning if blocked if (result.spam?.blocked) { console.warn("Message flagged as spam:", result.spam.reason); } } catch (error) { console.error("Failed to send message:", error); } }; useEffect(() => { if (scrollRef.current) { scrollRef.current.scrollIntoView({ behavior: "smooth" }); } }, [localMessages]); const currentChannelName = CHANNELS.find(c => c.id === activeChannel)?.name; const currentUserData = users.find(u => u.id === currentUser.id); return ( <div className="flex h-screen w-full bg-[#313338] text-gray-100 font-sans overflow-hidden"> {/* Server Sidebar */} <div className="w-[72px] bg-[#1E1F22] flex flex-col items-center py-3 gap-2 shrink-0"> <div className="w-12 h-12 rounded-[24px] bg-[#36393f] hover:bg-[#5865F2] hover:rounded-[16px] transition-all cursor-pointer flex items-center justify-center text-white mb-2"> <span className="text-sm font-bold">DM</span> </div> <Separator className="w-8 bg-[#35363C] mb-2" /> <div className="relative group"> <div className="absolute left-0 top-0 bottom-0 w-1 bg-white rounded-r-full my-auto h-10 -ml-4" /> <Avatar className="w-12 h-12 rounded-[16px] cursor-pointer"> <AvatarImage src={botAvatar} /> SV</AvatarFallback> </Avatar> </div> <div className="w-12 h-12 rounded-[24px] bg-[#36393f] hover:bg-[#3ba55c] hover:rounded-[16px] transition-all cursor-pointer flex items-center justify-center text-green-500 mt-auto"> <Plus size={24} /> </div> </div> {/* Channel Sidebar */} <div className="w-60 bg-[#2B2D31] flex flex-col shrink-0"> <div className="h-12 px-4 flex items-center shadow-sm border-b border-[#1f2023] hover:bg-[#35373C] cursor-pointer transition-colors"> <h1 className="font-bold text-[15px] truncate">Utility Bot Test Server</h1> </div> <ScrollArea className="flex-1 px-2 py-3"> <div className="mb-4"> <div className="px-2 text-xs font-bold text-[#949BA4] uppercase hover:text-gray-300 cursor-pointer flex items-center gap-1 mb-1"> <span className="text-[10px]">â–¼</span> Text Channels </div> <div className="space-y-[2px]"> {CHANNELS.map(channel => ( <div key={channel.id} onClick={() => setActiveChannel(channel.id)} data-testid={`channel-${channel.id}`} className={cn( "px-2 py-[6px] rounded mx-1 flex items-center gap-1.5 cursor-pointer group", activeChannel === channel.id ? "bg-[#404249] text-white" : "text-[#949BA4] hover:bg-[#35373C] hover:text-gray-200" )} > <Hash className="w-5 h-5 text-[#80848E]" /> <span className="font-medium truncate">{channel.name}</span> </div> ))} </div> </div> </ScrollArea> {/* User Control Panel */} <div className="h-[52px] bg-[#232428] px-2 flex items-center gap-2 shrink-0"> <Avatar className="w-8 h-8 relative cursor-pointer hover:opacity-80"> <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-[2px] border-[#232428] z-10"></div> <AvatarFallback className="bg-indigo-500 text-xs">AD</AvatarFallback> </Avatar> <div className="flex-1 min-w-0"> <div className="text-sm font-semibold text-white truncate leading-tight">AdminUser</div> <div className="text-xs text-[#949BA4] truncate leading-tight">#0001</div> </div> <div className="flex items-center"> <button className="p-1.5 hover:bg-[#3F4147] rounded"><Mic size={18} /></button> <button className="p-1.5 hover:bg-[#3F4147] rounded"><Headphones size={18} /></button> <button className="p-1.5 hover:bg-[#3F4147] rounded"><Settings size={18} /></button> </div> </div> </div> {/* Chat Area */} <div className="flex-1 flex flex-col min-w-0 bg-[#313338]"> {/* Header */} <div className="h-12 px-4 flex items-center shadow-sm border-b border-[#26272D] shrink-0"> <Hash className="w-6 h-6 text-[#80848E] mr-2" /> <h3 className="font-bold text-white mr-4">{currentChannelName}</h3> <div className="flex-1" /> {settings && ( <div className="text-xs text-[#949BA4]"> Event: {settings.eventActive ? "ðŸŸ¢ ON" : "ðŸ”´ OFF"} | Rate: {settings.pokecoinRate}/10 msgs </div> )} </div> {/* Messages */} <ScrollArea className="flex-1 px-4 pt-4"> <div className="flex flex-col justify-end min-h-full pb-4 space-y-4"> <div className="mt-auto mb-8 px-4"> <div className="w-16 h-16 bg-[#41434A] rounded-full flex items-center justify-center mb-4"> <Hash className="w-10 h-10 text-white" /> </div> <h1 className="text-3xl font-bold mb-2">Welcome to #{currentChannelName}!</h1> <p className="text-[#B5BAC1]">This is the start of the #{currentChannelName} channel.</p> </div> {localMessages.filter(m => m.channelId === activeChannel).map((msg) => ( <div key={msg.id} className={cn("flex gap-4 px-2 py-0.5 hover:bg-[#2e3035] group", msg.isBot && "bg-[#2f3136]/50")} data-testid={`message-${msg.id}`}> <Avatar className="w-10 h-10 mt-0.5 cursor-pointer hover:drop-shadow-md transition-all"> {msg.isBot ? ( <AvatarImage src={botAvatar} /> ) : ( <AvatarFallback className="bg-indigo-500 text-white text-xs">AD</AvatarFallback> )} </Avatar> <div className="flex-1 min-w-0"> <div className="flex items-center gap-2"> <span className={cn("font-medium hover:underline cursor-pointer", msg.isBot ? "text-[#5865F2]" : "text-white")}> {msg.isBot ? "Utility Bot" : currentUser.username} </span> {msg.isBot && ( <span className="bg-[#5865F2] text-white text-[10px] px-1.5 rounded-[3px] py-[1px] font-bold flex items-center h-[15px]">BOT</span> )} <span className="text-xs text-[#949BA4] ml-1"> Today at {msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} </span> </div> <div className="text-[#DBDEE1] whitespace-pre-wrap break-words leading-[1.375rem]"> {msg.content} </div> </div> </div> ))} <div ref={scrollRef} /> </div> </ScrollArea> {/* Input Area */} <div className="px-4 pb-6 pt-2 shrink-0"> <div className="bg-[#383A40] rounded-lg px-4 py-2.5 flex items-center gap-3"> <div className="w-6 h-6 rounded-full bg-[#B5BAC1] flex items-center justify-center cursor-pointer hover:text-white"> <Plus className="text-[#383A40] w-4 h-4 font-bold" /> </div> <form onSubmit={(e) => { e.preventDefault(); handleSend(); }} className="flex-1"> <input value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder={`Message #${currentChannelName}`} data-testid="input-message" className="w-full bg-transparent text-[#DBDEE1] placeholder-[#949BA4] focus:outline-none font-light" /> </form> <div className="flex items-center gap-3 text-[#B5BAC1]"> <Gift className="w-6 h-6 cursor-pointer hover:text-[#DBDEE1]" /> <Sticker className="w-6 h-6 cursor-pointer hover:text-[#DBDEE1]" /> <Smile className="w-6 h-6 cursor-pointer hover:text-[#DBDEE1]" /> </div> </div> </div> </div> {/* Members Sidebar */} <div className="w-60 bg-[#2B2D31] hidden lg:flex flex-col shrink-0 p-3"> <h2 className="text-[#949BA4] text-xs font-bold uppercase mb-4 px-2">Online â€” {users.length + 1}</h2> <div className="flex items-center gap-3 px-2 py-1.5 hover:bg-[#35373C] rounded cursor-pointer group"> <div className="relative"> <Avatar className="w-8 h-8"> <AvatarImage src={botAvatar} /> </Avatar> <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-[3px] border-[#2B2D31]"></div> </div> <div> <div className="font-medium text-white flex items-center gap-1"> Utility Bot <span className="bg-[#5865F2] text-white text-[9px] px-1 rounded py-[1px]">BOT</span> </div> <div className="text-xs text-[#949BA4]">Playing .help</div> </div> </div> <div className="flex items-center gap-3 px-2 py-1.5 hover:bg-[#35373C] rounded cursor-pointer group"> <div className="relative"> <Avatar className="w-8 h-8"> <AvatarFallback className="bg-indigo-500 text-xs">AD</AvatarFallback> </Avatar> <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-[3px] border-[#2B2D31]"></div> </div> <div> <div className="font-medium text-[#F0B232]">AdminUser</div> <div className="text-xs text-[#949BA4]"> {currentUserData ? `ðŸ’¬ ${currentUserData.messages} | ðŸª™ ${currentUserData.pokecoins}` : "Server Owner"} </div> </div> </div> </div> </div> );
}